---
title: "Developing odbc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Developing odbc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette is intended to help developers of the R package install needed dependencies.

While the odbc package contains some documentation on how to install and configure database drivers in `vignette("setup")`, the documentation assumes that users are connecting to databases that have already been set up. In order to test package functionality, though, odbc sets up small example database deployments.

## PostgreSQL

On MacOS, install PostgreSQL and the PostgreSQL drivers with:

```shell
brew install postgresql@14
brew install psqlodbc
```

Then, ensure that the `obdc.ini` and `odbcinst.ini` configuration files note an entry for PostgreSQL. For example entries in those files, see `.github/odbc`. To locate the driver on your system, see the output of `psqlodbc | grep -E '.(dylib|so)$'`.

To launch a PostgreSQL server locally, run:

```
brew services start postgresql@14
```

Next, create a database called "test" (or by whatever name is in the entry `Database` in your `odbc.ini` file):

```shell
createdb test
```

At this point, you should be able to connect to PostgreSQL through the R interface. Connect with:

```r
postgres <- dbConnect(odbc(), "PostgreSQL")
```

where `"PostgreSQL"` is replaced with whatever DSN you've configured.


## MySQL

First, installing MySQL with Homebrew:

```shell
brew install mysql@8.2
```

Available installers of the MySQL drivers (called the Connector/ODBC for MySQL) on Unix systems assume the iODBC driver manager. The driver thus needs to be installed from source.

Clone the [mysql-connector-odbc source](https://github.com/mysql/mysql-connector-odbc).

Edit the source of `dltest/dltest.c` to include:

```c
#include <string.h>
```

in the first few lines, and similarly for `test/odbctap.h`:

```c
#include <wchar.h>
#include <stdio.h>
```

Set the working directory to the source project (this will already be done if you've opened the repository as an RStudio project). Then, run:

```shell
brew install openssl@3
```

We'll tell the MySQL connection to compile with unixODBC and a homebrew install of openssl. Use `brew info openssl@3` to locate your install of openssl. Substitute `2.3.12` below with the version of your unixODBC install appropriately by navigating to `/opt/homebrew/Cellar/unixodbc/` and choosing the most recent installation.

Then:

```shell
cmake -G "Unix Makefiles" -DWITH_UNIXODBC=1 -DWITH_SSL=/opt/homebrew/opt/openssl@3 -DODBC_INCLUDES=/opt/homebrew/Cellar/unixodbc/2.3.12/include -DODBC_LIB_DIR=/opt/homebrew/Cellar/unixodbc/2.3.12/lib
```

Towards the end of log outputs, you should see:

```
-- OpenSSL library: /opt/homebrew/opt/openssl@3/lib/libssl.dylib
```

or similar. If you see "not found," you will need to [troubleshoot your SSL library path](https://dev.mysql.com/doc/refman/8.0/en/source-ssl-library-configuration.html). 

Finally:

```
make

sudo make install
```

For more information on the above, see [MySQL's docs](https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-source-unix.html) and the arguments noted on the [installation documentation](https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-source-unix.html); you will likely need to set additional arguments.

At the `make` step, you may see an error related to missing libraries.  If so, you'll need to (re)install the noted library with brew, clear the results of `cmake` from the source directory (I used `usethis:::git_clean()` to do so), and start again from the `cmake` step.

```
is a symlink belonging to openssl@3. You can unlink it:
  brew unlink openssl@3

To force the link and overwrite all conflicting files:
  brew link --overwrite openssl@1.1
```

Once the driver is correctly installed, find the sample `.ini` files linked in the `sudo make install` output and add them to your configuration files noted in `odbcinst -j`. Remove the `DATABASE` key entry and set:

```
UID             = root
PASSWORD        =
```

After running `brew services start mysql` if needed, and confirming that the database is running with `brew services info mysql`, you should be able to:

```
library(odbc)
dbConnect(odbc(), "myodbc8w")
```

Where `"myodbc8w"` is substituted with the DSN you've configured.

## SQL Server test setup

To run Microsoft SQL Server on **aarch64 (e.g. M1 or M2) MacOS**, you will need: 

* Docker 4.16 or higher
* MacOS 13 Ventura (or higher)

If needed, install Docker with:

```shell
brew install --cask docker
```

The Docker Desktop app provides a GUI to monitor deployed Docker containers and lives in `Docker.app > Show Package Contents > Contents > MacOS > Docker Desktop.app`.

To [install the SQL Server ODBC driver and (optional) command line tool](https://learn.microsoft.com/en-us/sql/connect/odbc/linux-mac/install-microsoft-odbc-driver-sql-server-macos?view=sql-server-ver15), use:

```shell
brew tap microsoft/mssql-release https://github.com/Microsoft/homebrew-mssql-release
brew install microsoft/mssql-release/msodbcsql18 microsoft/mssql-release/mssql-tools18
```

The `odbc.ini` entry should look something like:

```ini
[MicrosoftSQLServer]
driver = ODBC Driver 18 for SQL Server
Server = 127.0.0.1
port = 1433
Encrypt = no
```

In  `odbcinst.ini`:

```ini
[ODBC Driver 18 for SQL Server]
Description=Microsoft ODBC Driver 18 for SQL Server
Driver=/opt/homebrew/lib/libmsodbcsql.18.dylib
UsageCount=1
```

With docker and the needed driver installed, deploy the container with:

```shell
sudo docker run \
  --platform linux/amd64 \
  -e "ACCEPT_EULA=Y" \
  -e "MSSQL_SA_PASSWORD=BoopBop123!" \
  -p 1433:1433 \
   --name sql1 \
   --hostname sql1 \
   -d mcr.microsoft.com/mssql/server:2022-latest
```

The `--platform` tag is correct for M1; if you see `Status: Exited (1)` in Docker Desktop or a warning about incompatible architectures, navigate to `Settings > General` and ensure that `Use Rosetta for x86/amd64 emulation on Apple Silicon` is checked.

To connect via odbc, we need to pass the UID and PWD via the connection string; configuring those arguments via `odbc.ini` is [not permitted](https://stackoverflow.com/questions/42387084/sql-server-odbc-driver-linux-username). With the container deployed as above, the connection arguments would be:

```r
con <- dbConnect(odbc::odbc(), 
                 dsn = "MicrosoftSQLServer", 
                 uid = "SA", 
                 pwd = "BoopBop123!"
                 )
```

Then do some configuration of the server to add a testuser and create the test database

To configure a server to add a testing user and create a test database:

```r
# Add a test user, but currently unused
dbExecute(con, "USE test")
dbExecute(con, "EXEC sp_configure 'contained database authentication', 1")
dbExecute(con, "RECONFIGURE")
dbExecute(con, "alter database test set containment = partial")
dbExecute(con, "CREATE USER testuser with password = 'BoopBop123!'")
dbExecute(con, "GRANT CONTROL TO testuser")
dbExecute(con, "DROP USER testuser")

# Create a test database
dbExecute(con, "CREATE DATABASE test")
```

On **Linux**, create a docker container with:

```shell
docker run -v "$(pwd)":"/opt/$(basename $(pwd))":delegated --security-opt=seccomp:unconfined --link sql1 -it rstudio/r-base:3.6.1-bionic /bin/bash
```

Then run:

```shell
curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
#Ubuntu 18.04
curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list > /etc/apt/sources.list.d/mssql-release.list

apt-get update
ACCEPT_EULA=Y apt-get install -y msodbcsql17
apt-get install -y unixodbc-dev
```

The resulting `odbc.ini` file will look something like:

```ini
[MicrosoftSQLServer]
driver = ODBC Driver 17 for SQL Server
Server = sql1
port = 1433
Database = test
```

## Oracle

A huge pain.

Get the DB container:

```shell
docker login

docker pull store/oracle/database-enterprise:12.2.0.1
```

Start the container:

```shell
docker run -d -it --name oracle_db -P store/oracle/database-enterprise:12.2.0.1
```

The `-P` is important to set up the port forwarding from the docker container.


Then, query the port and edit the ports in `tnsnames.ora`:

```shell
docker port oracle_db
```

The contents of `snsnames.ora` should look like:

```
ORCLCDB=(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=127.0.0.1)(PORT=32769))
    (CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=ORCLCDB.localdomain)))
ORCLPDB1=(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=127.0.0.1)(PORT=32769))
    (CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=ORCLPDB1.localdomain)))
```

Ensure that the current working directly is [set appropriately](https://www.ibm.com/support/pages/how-configure-tnsnamesora-use-dedicated-server-process-datastage-connections-oracle-databases#:~:text=accessed%20via%20DataStage%3A-,The%20tnsnames.,specified%20by%20the%20TNS_ADMIN%20variable.). 

Then, to add a new user to the database:

```shell
docker exec -it oracle_db bash -c "source /home/oracle/.bashrc; sqlplus SYS/Oradoc_db1 AS SYSDBA"
```

```sql
alter session set "_ORACLE_SCRIPT"=true;

create user test identified by 12345;

GRANT ALL PRIVILEGES TO TEST;
```

Finally, in R:

```r
Sys.setenv("TNS_ADMIN" = getwd())
con <- dbConnect(odbc::odbc(), "OracleODBC-19")
```

## RODBC

We need to install the RODBC package for benchmarking in the vignette `vignette("benchmarks")`. The CRAN version of RODBC uses iODBC, so to use unixODBC we need to recompile it from source, specifying the odbc manager explicitly:

```r
install.packages("RODBC", type = "source", INSTALL_opts="--configure-args='--with-odbc-manager=odbc'")
```
